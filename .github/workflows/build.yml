name: Build ParVu

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux (Binary + DEB)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v1
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.13

    - name: Install dependencies
      run: uv sync --extra build

    - name: Build with PyInstaller
      run: uv run pyinstaller parvu.spec --clean --noconfirm

    - name: Create .deb package
      run: |
        VERSION=$(grep "^version" pyproject.toml | cut -d'"' -f2)
        DEB_DIR="ParVu-${VERSION}-deb"

        mkdir -p ${DEB_DIR}/DEBIAN
        mkdir -p ${DEB_DIR}/usr/local/bin
        mkdir -p ${DEB_DIR}/usr/share/applications
        mkdir -p ${DEB_DIR}/usr/share/parvu
        mkdir -p ${DEB_DIR}/usr/share/doc/parvu

        cp -r dist/parvu/* ${DEB_DIR}/usr/share/parvu/

        cat > ${DEB_DIR}/usr/local/bin/parvu << 'EOF'
        #!/bin/bash
        cd /usr/share/parvu
        exec ./parvu "$@"
        EOF
        chmod +x ${DEB_DIR}/usr/local/bin/parvu

        cat > ${DEB_DIR}/usr/share/applications/parvu.desktop << EOF
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=ParVu
        Comment=Parquet, CSV, and JSON File Viewer
        Exec=/usr/local/bin/parvu %F
        Terminal=false
        Categories=Development;Utility;
        Keywords=parquet;csv;json;viewer;data;
        MimeType=application/x-parquet;text/csv;application/json;
        EOF

        cat > ${DEB_DIR}/DEBIAN/control << EOF
        Package: parvu
        Version: ${VERSION}
        Section: utils
        Priority: optional
        Architecture: amd64
        Maintainer: ParVu Developers <https://github.com/AzizNadirov/ParVu>
        Description: Parquet, CSV, and JSON File Viewer
         ParVu is a powerful desktop application for viewing and querying
         large Parquet, CSV, and JSON files.
        EOF

        cp README.md ${DEB_DIR}/usr/share/doc/parvu/
        dpkg-deb --build ${DEB_DIR}
        mv ${DEB_DIR}.deb ParVu-${VERSION}-amd64.deb

    - name: Create portable archive
      run: |
        VERSION=$(grep "^version" pyproject.toml | cut -d'"' -f2)
        cd dist
        tar czf ../ParVu-${VERSION}-linux-x86_64.tar.gz parvu/

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: parvu-linux-binary
        path: dist/parvu/

    - name: Upload .deb package
      uses: actions/upload-artifact@v4
      with:
        name: parvu-linux-deb
        path: ParVu-*.deb

    - name: Upload portable archive
      uses: actions/upload-artifact@v4
      with:
        name: parvu-linux-portable
        path: ParVu-*-linux-x86_64.tar.gz

  build-windows:
    name: Build Windows (Portable)
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v1
      with:
        version: "latest"

    - name: Set up Python
      run: uv python install 3.13

    - name: Install dependencies
      run: uv sync --extra build

    - name: Build with PyInstaller
      run: uv run pyinstaller parvu.spec --clean --noconfirm

    - name: Create portable ZIP
      shell: pwsh
      run: |
        $version = (Get-Content pyproject.toml | Select-String '^version').ToString().Split('"')[1]
        Compress-Archive -Path "dist\parvu\*" -DestinationPath "ParVu-$version-portable-win64.zip" -Force

    - name: Upload binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: parvu-windows-binary
        path: dist/parvu/

    - name: Upload portable ZIP
      uses: actions/upload-artifact@v4
      with:
        name: parvu-windows-portable
        path: ParVu-*-portable-win64.zip

  release:
    name: Create Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          parvu-linux-deb/*.deb
          parvu-linux-portable/*.tar.gz
          parvu-windows-portable/*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
